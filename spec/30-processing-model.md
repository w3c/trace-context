# Processing Model

This section provides a step-by-step example of a tracing vendor receiving a request with trace context headers, processing the request and then potentially forwarding it. This description can be used as a reference when implementing a trace context-compliant tracing system, middleware (like a proxy or messaging bus), or a cloud service.

## Processing Model for Working with Trace Context Request Header

This processing model describes the behavior of a vendor that modifies and forwards trace context headers. How the model works depends on whether or not a `traceparent` header is received.

### No traceparent Received

If no traceparent header is received:

1. The vendor checks an incoming request for a `traceparent` and a `tracestate` header.
2. Because the `traceparent` header is not received, the vendor creates a new `trace-id` and `parent-id` that represents the current request. (Note: If the vendor does not sample this request and wants to communicate that sampling decision downstream via the `sampled` flag, the vendor MAY create a `trace-id` and `parent-id` that are not associated with any actual trace data. The vendor MAY also decide to not communicate the sampling decision downstream.)
3. If a `tracestate` header is received without an accompanying `traceparent` header, it is invalid and MUST be discarded.
4. The vendor SHOULD create a new `tracestate` header and add a new key/value pair.
5. The vendor sets the `traceparent` and `tracestate` header for the outgoing request.

### A traceparent is Received

If a `traceparent` header is received:

1. The vendor checks an incoming request for a `traceparent` and a `tracestate` header.
2. Because the `traceparent` header _is present_, the vendor tries to parse the version of the `traceparent` header.
    1. If the _version cannot be parsed_, the vendor creates a new `traceparent` header and deletes `tracestate`.
    2. If the _version number is higher_ than supported by the tracer, the vendor uses the format defined in this specification (`00`) to parse `trace-id` and `parent-id`.
The vendor will only parse the `trace-flags` values supported by this version of this specification and ignore all other values. If parsing fails, the vendor creates a new `traceparent` header and deletes the `tracestate`. Vendors will set all unparsed / unknown `trace-flags` to 0 on outgoing requests.
    3. If the vendor _supports the version number_, it validates `trace-id` and `parent-id`. If either `trace-id`, `parent-id` or `trace-flags` are invalid, the vendor creates a new `traceparent` header and deletes `tracestate`.
3. The vendor MAY validate the `tracestate` header. If the `tracestate` header cannot be parsed the vendor MAY discard the entire header. Invalid `tracestate` entries MAY also be discarded.
4. For each outgoing request the vendor performs the following steps:
     1. The vendor MUST modify the `traceparent` header:
        * **Update `parent-id`:** The value of property `parent-id` MUST be set to a value representing the ID of the current operation.
        * **Update `sampled`:** The value of `sampled` reflects the caller's recording behavior. The value of the `sampled` flag of `trace-flags` MAY be set to `1` if the trace data is likely to be recorded or to `0` otherwise. Setting the flag is no guarantee that the trace will be recorded but increases the likeliness of end-to-end recorded traces.

     2. The vendor MAY modify the `tracestate` header:
        * **Update a key value:** The value of any key can be updated. Modified keys MUST be moved to the beginning (left) of the list.
        * **Add a new key/value pair:** The new key-value pair MUST be added to the beginning (left) of the list.
        * **Delete a key/value pair:** Any key/value pair MAY be deleted. Vendors SHOULD NOT delete keys that weren't generated by themselves. Deletion of any key/value pair MAY break correlation in other systems.
     3. The vendor sets the `traceparent` and `tracestate` header for the outgoing request.

### Alternative Processing

The processing model above describes the complete set of steps for processing trace context headers. There are, however, situations when a vendor might only support a subset of the steps described above. Proxies or messaging middleware MAY decide not to modify the `traceparent` headers but remove invalid headers or add additional information to `tracestate`.
